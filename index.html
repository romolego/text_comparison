<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð² (TXT, DOCX, XLSX, PPTX, PDF)</title>

<!-- Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ -->
<script src="./mammoth.browser.min.js"></script>
<script src="./xlsx.full.min.js"></script>
<script src="./jszip.min.js"></script>
<script src="./pdf.min.js"></script>
<script src="./pdf.worker.min.js"></script>
<!-- Diff-Match-Patch (Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ€Ð¾Ð²Ð½Ð¾ Ð¾Ð´Ð½Ñƒ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÑƒ) -->
<script src="./diff_mat2.js"></script>

<style>
:root{
  --bg:#fff; --fg:#111; --muted:#666; --accent:#0a67ff;
  --ins-bg:#d8ffd8; --del-bg:#ffd8d8;
  --border:#ccc; --left-border:#ffd54d; --right-border:#57e389;
}
*{box-sizing:border-box}
body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px;}
h1{font-size:20px;margin:0 0 16px;}

.row{display:flex;gap:40px;justify-content:space-between;flex-wrap:wrap;}
.col{flex:1;display:flex;flex-direction:column;gap:6px;}
textarea{width:100%;min-height:220px;padding:10px;resize:vertical;border:2px solid var(--border);border-radius:8px;font-family:Consolas,monospace;font-size:13px;background:#fff;}
#left{border-color:var(--left-border);}
#right{border-color:var(--right-border);}
.count{font-size:12px;color:var(--muted);}
.btns{display:flex;gap:6px;flex-wrap:wrap;}
button{cursor:pointer;appearance:none;border:1px solid var(--border);background:#f6f6f6;padding:7px 10px;border-radius:6px;transition:.15s;}
button.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
button.big{padding:16px 24px;font-weight:700;font-size:18px;}
button.small{font-size:13px;padding:5px 8px;}
button:hover{filter:brightness(0.95);}

/* ÐŸÐ¾Ð´ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑÐ¼Ð¸ */
.action-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;margin:28px 0;}
.action-center{grid-column:2;justify-self:center;}
.action-right{grid-column:3;justify-self:end;display:flex;gap:8px;}
#compareBtn{margin-top:12px;margin-bottom:12px;}

/* Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ */
#resultWrap{position:relative;margin-top:8px;}
#resultToolbar{display:grid;grid-template-columns:1fr auto 1fr;align-items:baseline;gap:8px;padding:6px 0;}
#rt-left{justify-self:start;display:flex;gap:8px;flex-wrap:wrap;}
#status{justify-self:center;font-weight:600;}
  .legend{justify-self:right;font-size:13px;color:var(--muted);padding-right:10px;}
.result{border:1px solid var(--border);border-radius:8px;padding:10px;background:#fff;min-height:80px;white-space:pre-wrap;word-wrap:break-word;}
ins{background:var(--ins-bg);text-decoration:none;border-radius:3px;}
del{background:var(--del-bg);text-decoration:line-through;border-radius:3px;}
.result ins,.result del{scroll-margin-top:100px;}
#resultWrap.vcompact .result{max-height:50vh; overflow:auto;}

/* ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° */
#exportRow{display:flex;justify-content:flex-start;margin:18px 0 6px;}
#exportWordBtn{
  display:inline-block;padding:8px 16px;font-weight:600;border-radius:10px;border:1px solid var(--border);
  background:linear-gradient(135deg,#e7f3ff,#d6e9ff);color:#004a9f;cursor:pointer;transition:.2s;line-height:1;
}

/* Ð‘Ð»Ð¾Ðº Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ: ÐºÐ½Ð¾Ð¿ÐºÐ° Ð²Ñ‹Ð½ÐµÑÐµÐ½Ð° ÐÐÐ” Ð±Ð»Ð¾ÐºÐ¾Ð¼ Ð»Ð¾Ð³Ð° */
#logToggleRow{display:flex;justify-content:center;margin:18px 0 6px;}
#logToggleBtn{
  display:inline-block;padding:8px 16px;font-weight:600;border-radius:10px;border:1px solid var(--border);
  background:linear-gradient(135deg,#e7f3ff,#d6e9ff);color:#004a9f;cursor:pointer;transition:.2s;line-height:1;
}
#logToggleBtn.off{background:linear-gradient(135deg,#fbe4e4,#ffe9e9);color:#a40000;}
#logToggleBtn:hover{filter:brightness(0.95);}

/* Ð¡Ð°Ð¼ Ð±Ð»Ð¾Ðº Ð»Ð¾Ð³Ð° */
#logWrap{position:relative;margin-top:6px;}
#logToolbar{display:flex;justify-content:space-between;align-items:center;margin:6px 0 8px;gap:8px;flex-wrap:wrap;}
#logLeft{display:flex;align-items:center;gap:10px;}
#logModeBtns{display:flex;gap:6px;}
#logSection{border:1px solid var(--border);border-radius:8px;padding:8px;background:#fff;}
#logSection.hidden{display:none;}
#logWrap.hidden{display:none;} /* Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð»Ð¾Ð³ Ð¿Ñ€Ð¸ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸ */

.logEntry{border:1px solid var(--border);border-radius:6px;padding:8px 10px;margin:6px 0;background:#fafafa;display:flex;align-items:flex-start;gap:8px;}
.logMain{flex:1 1 auto;min-width:0;}
.logMeta{font-size:13px;margin-bottom:4px;}
.logPreview{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.logBtns{flex:0 0 auto;display:flex;gap:8px;margin-left:auto;}
.iconBtn{width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;border-radius:6px;}
.iconRestore{background:#e9f2ff;border-color:#bcd5ff;}
.iconDelete{background:#ffe9e9;border-color:#ffc7c7;color:#a80000;}
#logWrap.vcompact #logSection{max-height:33vh; overflow:auto;}

/* ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ */
#navPanel{position:fixed;right:15px;top:40%;display:flex;flex-direction:column;gap:6px;padding:6px;border-radius:10px;background:rgba(250,250,250,0.9);box-shadow:0 0 6px rgba(0,0,0,0.15);z-index:999;transition:opacity .3s;}
#navPanel.hidden{opacity:0;pointer-events:none;}
.navBtn{width:34px;height:34px;border-radius:50%;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:.2s;}
.navBtn:hover{background:#f0f8ff;}
.divider{border-top:1px solid var(--border);margin:4px 0;}
</style>
</head>
<body>
<div class="wrap">
  <h1>Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð² (TXT, DOCX, XLSX, PPTX, PDF)</h1>

  <div class="row">
    <div class="col">
      <label>ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ (Ð´Ð¾)</label>
      <textarea id="left" placeholder="Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚â€¦"></textarea>
      <div class="count" id="countLeft">Ð¡Ð¸Ð¼Ð²Ð¾Ð»Ð¾Ð²: 0</div>
      <div class="btns">
        <button data-paste="left" class="small">Ð’ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ</button>
        <button data-clear="left" class="small">ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ</button>
        <input type="file" class="file" id="fileLeft" accept=".txt,.docx,.xlsx,.pptx,.pdf" hidden>
        <button data-load="left" class="small">Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ</button>
      </div>
    </div>
    <div class="col">
      <label>Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ (Ð¿Ð¾ÑÐ»Ðµ)</label>
      <textarea id="right" placeholder="Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¸Ð·Ð¼ÐµÐ½Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚â€¦"></textarea>
      <div class="count" id="countRight">Ð¡Ð¸Ð¼Ð²Ð¾Ð»Ð¾Ð²: 0</div>
      <div class="btns">
        <button data-paste="right" class="small">Ð’ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ</button>
        <button data-clear="right" class="small">ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ</button>
        <input type="file" class="file" id="fileRight" accept=".txt,.docx,.xlsx,.pptx,.pdf" hidden>
        <button data-load="right" class="small">Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ</button>
      </div>
    </div>
  </div>

  <div class="action-row">
    <div class="action-center"><button id="compareBtn" class="primary big">Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ</button></div>
    <div class="action-right">
      <button id="swapBtn" class="small">ÐŸÐ¾Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð¼ÐµÑÑ‚Ð°Ð¼Ð¸</button>
      <button id="clearAllBtn" class="small">ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÑ‘</button>
    </div>
  </div>

  <div id="resultWrap">
    <div id="resultToolbar">
      <div id="rt-left">
        <button id="toggleViewBtn" class="small">ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ðµ</button>
        <button id="resultCompactBtn" class="small">Ð¡Ð¶Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð²Ñ‹ÑÐ¾Ñ‚Ðµ</button>
      </div>
      <div id="status">â€”</div>
      <div class="legend">Ð›ÐµÐ³ÐµÐ½Ð´Ð°: <del>ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾</del>, <ins>Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾</ins></div>
    </div>
    <div id="out" class="result"></div>
  </div>

  <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° Ð² Word -->
  <div id="exportRow">
    <button id="exportWordBtn">Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Word</button>
  </div>

  <!-- Ð’Ñ‹Ð½ÐµÑÐµÐ½Ð½Ð°Ñ ÐºÐ½Ð¾Ð¿ÐºÐ° Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ, Ð¿Ð¾ Ñ†ÐµÐ½Ñ‚Ñ€Ñƒ Ð½Ð°Ð´ Ð»Ð¾Ð³Ð¾Ð¼ -->
  <div id="logToggleRow">
    <button id="logToggleBtn">ÐÐµ Ð²ÐµÑÑ‚Ð¸ Ð»Ð¾Ð³</button>
  </div>

  <!-- Ð‘Ð»Ð¾Ðº Ð»Ð¾Ð³Ð° (Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸) -->
  <div id="logWrap">
    <div id="logToolbar">
      <div id="logLeft">
        <h3 style="margin:0;">Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð»Ð¾Ð³ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ð¹</h3>
      </div>
      <div id="logModeBtns">
        <button id="logCompactBtn" class="small">Ð¡Ð¶Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð²Ñ‹ÑÐ¾Ñ‚Ðµ</button>
        <button id="clearLog" class="small">ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³</button>
      </div>
    </div>
    <div id="logSection" class="hidden">
      <div id="logList"></div>
    </div>
  </div>
</div>

<!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸ -->
<div id="navPanel" class="hidden">
  <button class="navBtn" id="navTop" title="ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚Ð¸Ñ‚ÑŒ Ð²Ð²ÐµÑ€Ñ… ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹">â†‘</button>
  <button class="navBtn" id="navBottom" title="ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚Ð¸Ñ‚ÑŒ Ð²Ð½Ð¸Ð· ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹">â†“</button>
  <div class="divider"></div>
  <button class="navBtn" id="navPrev" title="ÐŸÑ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ">â†</button>
  <button class="navBtn" id="navNext" title="Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰ÐµÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ">â†’</button>
</div>

<script>
// Ð¡ÐµÐ¼Ð°Ð½Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´Ð¸Ñ„Ñ„ Ð½Ð° Ð±Ð°Ð·Ðµ Diff-Match-Patch (diff_mat2.js)
function diffStrings(text1, text2) {
  const dmp = new diff_match_patch();
  dmp.Diff_Timeout  = 3; // ÑÐµÐº.; 0 = Ð±ÐµÐ· Ð»Ð¸Ð¼Ð¸Ñ‚Ð°
  dmp.Diff_EditCost = 4;

  let diffs = dmp.diff_main(text1, text2);
  dmp.diff_cleanupSemantic(diffs);

  const result = [];
  for (let i = 0; i < diffs.length; i++) {
    const op = diffs[i][0];
    const val = diffs[i][1];
    if (!val) continue;
    if (op === 0)      result.push({ type: 'equal',  value: val });
    else if (op === -1) result.push({ type: 'delete', value: val });
    else if (op === 1)  result.push({ type: 'insert', value: val });
  }
  return result;
}

// ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð´ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
document.addEventListener('DOMContentLoaded', () => {
  if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.min.js';
  }

  const $=s=>document.querySelector(s);
  const left=$('#left'), right=$('#right'), out=$('#out');
  const countLeft=$('#countLeft'), countRight=$('#countRight');
  const statusEl=$('#status');

  const navPanel=$('#navPanel'), navTop=$('#navTop'), navBottom=$('#navBottom'), navPrev=$('#navPrev'), navNext=$('#navNext');

  const resultWrap=$('#resultWrap'), toggleBtn=$('#toggleViewBtn'), resultCompactBtn=$('#resultCompactBtn');

  const logWrap=$('#logWrap'), logSection=$('#logSection'), logList=$('#logList');
  const logToggleBtn=$('#logToggleBtn');
  const logCompactBtn=$('#logCompactBtn'), clearLogBtn=$('#clearLog');

  const exportWordBtn = $('#exportWordBtn');

  let lastRender={htmlAll:'',htmlOnly:'',fragments:0}, onlyChangesMode=false;
  let loggingEnabled=true, diffPositions=[], diffIndex=0;
  let resultCompact=false;  // 50vh
  let logCompact=false;     // 33vh

  function updateCount(){
    countLeft.textContent='Ð¡Ð¸Ð¼Ð²Ð¾Ð»Ð¾Ð²: '+left.value.length;
    countRight.textContent='Ð¡Ð¸Ð¼Ð²Ð¾Ð»Ð¾Ð²: '+right.value.length;
    saveState();
  }
  [left,right].forEach(t=>t.addEventListener('input',updateCount));

  [left,right].forEach(t=>{
    t.addEventListener('dragover',e=>{e.preventDefault();t.style.background='#f0f8ff';});
    t.addEventListener('dragleave',()=>{t.style.background='#fff';});
    t.addEventListener('drop',async e=>{
      e.preventDefault();t.style.background='#fff';
      const f=e.dataTransfer.files[0]; if(f) await readFile({target:{files:[f]}},t);
    });
  });

  async function extractPptxText(file){
    const buf=await file.arrayBuffer();
    const zip=await JSZip.loadAsync(buf);
    const slides=Object.keys(zip.files).filter(f=>f.startsWith("ppt/slides/slide")&&f.endsWith(".xml")).sort();
    let text="";
    for(const s of slides){
      const xml=await zip.files[s].async("string");
      const m=[...xml.matchAll(/<a:t[^>]*>([^<]*)<\/a:t>/g)];
      if(m.length) text+=m.map(x=>x[1]).join(" ")+"\n\n";
    }
    return text.trim();
  }
  async function extractPdfText(file){
    const arr=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:arr}).promise;
    let txt="";
    for(let i=1;i<=pdf.numPages;i++){
      const p=await pdf.getPage(i);
      const c=await p.getTextContent();
      txt+=c.items.map(it=>it.str).join(" ")+"\n";
    }
    return txt.trim();
  }
  async function readFile(e,target){
    const f=e.target.files[0]; if(!f) return;
    const ext=f.name.split('.').pop().toLowerCase();
    try{
      if(ext==='txt'){
        target.value=await f.text();
      }else if(ext==='docx'){
        const buf=await f.arrayBuffer();
        const r=await mammoth.extractRawText({arrayBuffer:buf});
        target.value=r.value;
      }else if(ext==='xlsx'){
        const data=await f.arrayBuffer();
        const wb=XLSX.read(data,{type:'array'});
        let txt=''; wb.SheetNames.forEach(n=>{txt+=XLSX.utils.sheet_to_csv(wb.Sheets[n])+'\n';});
        target.value=txt;
      }else if(ext==='pptx'){
        target.value=await extractPptxText(f);
      }else if(ext==='pdf'){
        target.value=await extractPdfText(f);
      }else{
        alert('ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚ÑÑ TXT, DOCX, XLSX, PPTX, PDF.');
      }
    }finally{
      updateCount(); saveState();
    }
  }

  document.querySelectorAll('[data-paste]').forEach(b=>b.onclick=async()=>{
    try{
      const txt=await navigator.clipboard.readText();
      (b.dataset.paste==='left'?left:right).value=txt;
      updateCount();
    }catch{
      alert('Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð±ÑƒÑ„ÐµÑ€Ñƒ Ð¸Ð»Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ (Ctrl+V).');
    }
  });
  document.querySelectorAll('[data-clear]').forEach(b=>b.onclick=()=>{(b.dataset.clear==='left'?left:right).value='';updateCount();});
  document.querySelectorAll('[data-load]').forEach(b=>b.onclick=()=>{(b.dataset.load==='left'?$('#fileLeft'):$('#fileRight')).click();});
  $('#fileLeft').onchange=e=>readFile(e,left);
  $('#fileRight').onchange=e=>readFile(e,right);
  $('#clearAllBtn').onclick=()=>{left.value='';right.value='';out.innerHTML='';statusEl.textContent='â€”';updateCount();onlyChangesMode=false;updateNavPanel();};
  $('#swapBtn').onclick=()=>{const t=left.value;left.value=right.value;right.value=t;updateCount();};

  const esc=s=>s.replace(/[&<>]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));

  function makeViews(diffResult) {
    let fragments = 0;
    const allParts = [];
    const onlyChangesParts = [];

    const mergedResult = [];
    if (diffResult.length > 0) {
        let current = {...diffResult[0]};
        for (let i = 1; i < diffResult.length; i++) {
            if (diffResult[i].type === current.type) {
                current.value += diffResult[i].value;
            } else {
                mergedResult.push(current);
                current = {...diffResult[i]};
            }
        }
        mergedResult.push(current);
    }

    mergedResult.forEach(item => {
        const escapedText = esc(item.value);
        switch (item.type) {
          case 'equal':
            allParts.push(escapedText);
            break;
          case 'delete':
            fragments++;
            allParts.push(`<del>${escapedText}</del>`);
            onlyChangesParts.push(`<del>${escapedText}</del>`);
            break;
          case 'insert':
            fragments++;
            allParts.push(`<ins>${escapedText}</ins>`);
            onlyChangesParts.push(`<ins>${escapedText}</ins>`);
            break;
        }
    });

    return {
      htmlAll: allParts.join(''),
      htmlOnly: onlyChangesParts.join(''),
      fragments: fragments
    };
  }

  function indexChanges(){
    const nodes=[...out.querySelectorAll('ins,del')];
    nodes.forEach((el,i)=>{ el.id='chg-'+i; });
  }
  function updateNavPanel(){
    const hasDiff=!!out.querySelector('ins,del');
    if(!hasDiff){ navPanel.classList.add('hidden'); diffPositions=[]; return; }
    indexChanges();
    diffPositions=[...out.querySelectorAll('ins,del')];
    diffIndex=0;
    navPanel.classList.remove('hidden');
  }

  function scrollToChange(offset){
    if(diffPositions.length===0) return;
    diffIndex=(diffIndex+offset+diffPositions.length)%diffPositions.length;
    const el=diffPositions[diffIndex];
    const useInnerScroll = out.scrollHeight > out.clientHeight;
    if(useInnerScroll){
      const y = el.offsetTop - 60;
      out.scrollTo({top: y < 0 ? 0 : y, behavior:'smooth'});
    }else{
      const rect=el.getBoundingClientRect();
      const y=rect.top+window.scrollY-100;
      window.scrollTo({top:y,behavior:'smooth'});
    }
    el.style.outline='2px solid #0a67ff';
    el.style.transition='outline-color .4s ease';
    setTimeout(()=>{ el.style.outlineColor='transparent'; },2000);
    setTimeout(()=>{ el.style.outline=''; el.style.transition=''; },2600);
  }
  navTop.onclick=()=>window.scrollTo({top:0,behavior:'smooth'});
  navBottom.onclick=()=>window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  navNext.onclick=()=>scrollToChange(+1);
  navPrev.onclick=()=>scrollToChange(-1);

  function addToLog(a,b,diff){
    let log=JSON.parse(localStorage.getItem('diffLog')||'[]');
    log.unshift({time:new Date().toLocaleString(),diff,al:a.slice(0,100),ar:b.slice(0,100),left:a,right:b});
    localStorage.setItem('diffLog',JSON.stringify(log));
    renderLog();
  }
  function renderLog(){
    if(!loggingEnabled){
      logWrap.classList.add('hidden');
      logToggleBtn.textContent='Ð’ÐµÑÑ‚Ð¸ Ð»Ð¾Ð³';
      logToggleBtn.classList.add('off');
      return;
    }
    logWrap.classList.remove('hidden');
    logToggleBtn.textContent='ÐÐµ Ð²ÐµÑÑ‚Ð¸ Ð»Ð¾Ð³';
    logToggleBtn.classList.remove('off');

    const log=JSON.parse(localStorage.getItem('diffLog')||'[]');
    logSection.classList.remove('hidden');
    logList.innerHTML='';
    log.forEach((x,i)=>{
      const e=document.createElement('div'); e.className='logEntry';
      const main=document.createElement('div'); main.className='logMain';
      main.innerHTML=`<div class="logMeta"><b>${x.time}</b> â€” Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð¸Ð¹: ${x.diff}</div>
                      <div class="logPreview">${esc(x.al)} â€¦ | ${esc(x.ar)} â€¦</div>`;
      const btns=document.createElement('div'); btns.className='logBtns';
      const bR=document.createElement('button'); bR.className='small iconBtn iconRestore'; bR.textContent='â†©'; bR.title='Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ'; bR.dataset.act='restore'; bR.dataset.i=i;
      const bD=document.createElement('button'); bD.className='small iconBtn iconDelete'; bD.textContent='âŒ'; bD.title='Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ'; bD.dataset.act='del'; bD.dataset.i=i;
      btns.append(bR,bD); e.append(main,btns); logList.append(e);
    });
  }
  logList.onclick=e=>{
    const t=e.target; if(!t.dataset.act) return;
    const i=+t.dataset.i;
    let log=JSON.parse(localStorage.getItem('diffLog')||'[]'); if(!(i in log)) return;
    if(t.dataset.act==='restore'){
      if(left.value===log[i].left && right.value===log[i].right) return;
      left.value=log[i].left; right.value=log[i].right; updateCount();
      compare(true); window.scrollTo({top:0,behavior:'smooth'});
    }else if(t.dataset.act==='del'){
      log.splice(i,1); localStorage.setItem('diffLog',JSON.stringify(log)); renderLog();
    }
  };
  clearLogBtn.onclick=()=>{ if(confirm('ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÐµÑÑŒ Ð»Ð¾Ð³?')){ localStorage.removeItem('diffLog'); renderLog(); } };

  function compare(skipLog=false){
    const a=left.value, b=right.value;
    if(!a&&!b){
      statusEl.textContent='â€”'; out.innerHTML=''; updateNavPanel(); return;
    }

    try {
      statusEl.textContent = 'Ð¡Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°ÐµÑ‚ÑÑ...';
      setTimeout(() => {
        try {
          const diffResult = diffStrings(a, b);
          const v = makeViews(diffResult);
          lastRender = v;

          if(a === b){
            statusEl.textContent='Ð¢ÐµÐºÑÑ‚Ñ‹ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÑŽÑ‚.';
            out.innerHTML=v.htmlAll;
          } else {
            statusEl.textContent=`Ð Ð°Ð·Ð»Ð¸Ñ‡Ð¸Ð¹: ${v.fragments}`;
            out.innerHTML=onlyChangesMode? v.htmlOnly : v.htmlAll;
            if(loggingEnabled && !skipLog) addToLog(a,b,v.fragments);
          }
          updateNavPanel();
          saveState();
        } catch (error) {
          statusEl.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ð¸';
          console.error('Comparison error:', error);
        }
      }, 10);
    } catch (error) {
      statusEl.textContent = 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ð¸';
      console.error('Comparison error:', error);
    }
  }

  $('#compareBtn').onclick=()=>compare(false);

  function exportToWord() {
    if (!lastRender || !lastRender.htmlAll) {
      alert('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²');
      return;
    }
    const content = onlyChangesMode ? lastRender.htmlOnly : lastRender.htmlAll;
    const htmlContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.4; }
          del { color: #cc0000; text-decoration: line-through; background-color: #ffd8d8; }
          ins { color: #006600; text-decoration: none; background-color: #d8ffd8; }
          .legend { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
        </style>
      </head>
      <body>
        <h1>Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²</h1>
        <div class="legend">
          <strong>Ð›ÐµÐ³ÐµÐ½Ð´Ð°:</strong>
          <del>ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚</del>,
          <ins>Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚</ins>
        </div>
        <div>${content}</div>
        <div style="margin-top: 30px; font-size: 12px; color: #666;">
          Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ ${new Date().toLocaleString()}
        </div>
      </body>
      </html>
    `;
    const blob = new Blob([htmlContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'comparison_result.doc';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  exportWordBtn.onclick = exportToWord;

  toggleBtn.onclick=()=>{
    onlyChangesMode=!onlyChangesMode;
    out.innerHTML=onlyChangesMode? lastRender.htmlOnly : lastRender.htmlAll;
    toggleBtn.textContent=onlyChangesMode?'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²ÑÑ‘':'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ðµ';
    updateNavPanel(); saveState();
  };
  resultCompactBtn.onclick=()=>{
    resultCompact=!resultCompact;
    resultWrap.classList.toggle('vcompact', resultCompact);
    resultCompactBtn.textContent=resultCompact?'Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ':'Ð¡Ð¶Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð²Ñ‹ÑÐ¾Ñ‚Ðµ';
    updateNavPanel(); saveState();
  };
  logCompactBtn.onclick=()=>{
    logCompact=!logCompact;
    logWrap.classList.toggle('vcompact', logCompact);
    logCompactBtn.textContent=logCompact?'Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ':'Ð¡Ð¶Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð²Ñ‹ÑÐ¾Ñ‚Ðµ';
    saveState();
  };

  function saveState(){
    localStorage.setItem('diffState', JSON.stringify({
      left:left.value, right:right.value, onlyChangesMode, loggingEnabled,
      resultCompact, logCompact
    }));
  }
  function loadState(){
    const st=JSON.parse(localStorage.getItem('diffState')||'null');
    if(st){
      left.value=st.left||''; right.value=st.right||'';
      onlyChangesMode=!!st.onlyChangesMode;
      loggingEnabled=(st.loggingEnabled!==false);
      resultCompact=!!st.resultCompact; logCompact=!!st.logCompact;
      resultWrap.classList.toggle('vcompact', resultCompact);
      logWrap.classList.toggle('vcompact', logCompact);
      toggleBtn.textContent=onlyChangesMode?'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²ÑÑ‘':'ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ðµ';
    }
    const s=localStorage.getItem('diffLogging'); if(s!==null) loggingEnabled=(s==='true');
    renderLog();
    resultCompactBtn.textContent=resultCompact?'Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ':'Ð¡Ð¶Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð²Ñ‹ÑÐ¾Ñ‚Ðµ';
    logCompactBtn.textContent=logCompact?'Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ':'Ð¡Ð¶Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð²Ñ‹ÑÐ¾Ñ‚Ðµ';
    updateCount();
  }

  function setLogging(enabled){
    loggingEnabled=enabled;
    localStorage.setItem('diffLogging',loggingEnabled);
    saveState();
    renderLog();
  }
  logToggleBtn.onclick=()=>setLogging(!loggingEnabled);

  loadState(); updateNavPanel();
});
</script>
</body>
</html>
